#!/usr/bin/perl -s
# Script to create a CLAN file
# Expects the template files to be present in the config sub-dir
# ACRM 11.09.15

use strict;

my $limit = (defined($::limit)?$::limit:0);

my $dir = shift @ARGV;
my $loop = shift @ARGV;

my ($start, $stop) = FindCDRBounds($loop);
my @pdblist        = ReadDirectory($dir);
my $header         = ReadClanHeader($loop);

WriteClanFile($header, $loop, $start, $stop, $limit, @pdblist);

sub WriteClanFile
{
    my ($header, $loop, $start, $stop, $limit, @pdblist) = @_;
    my $filename = "$loop.clan";
    my $count    = 0;
    if(open(FILE, '>', $filename))
    {
        print FILE $header;

        foreach my $file (@pdblist)
        {
            last if($limit && (++$count > $limit));
            print FILE "loop $file $start $stop\n";
        }
        close FILE;
    }
    else
    {
        die "Can't write CLAN file: $filename";
    }
}



sub ReadClanHeader
{
    my($loop) = @_;

    my $filename = "./config/$loop.clan";
    die "Clan header config doesn't exist: $filename" if(! -e $filename);

    my $content = `cat $filename`;
    return($content);
}

sub ReadDirectory
{
    my ($dir) = @_;

    my $listing = `\\ls -1 $dir`;
    my @files = split(/\n/, $listing);
    foreach my $file (@files)
    {
        $file = "$dir/$file";
    }
    return(@files);
}



sub FindCDRBounds
{
    my ($loop) = @_;
    my ($start, $stop);

    if($loop eq 'L1')
    {
        $start = 'L24';
        $stop  = 'L34';
    }
    elsif($loop eq 'L2')
    {
        $start = 'L50';
        $stop  = 'L56';
    }
    elsif($loop eq 'L3')
    {
        $start = 'L89';
        $stop  = 'L97';
    }
    elsif($loop eq 'H1')
    {
        $start = 'H26';
        $stop  = 'H35';
    }
    elsif($loop eq 'H2')
    {
        $start = 'H50';
        $stop  = 'H58';
    }
    elsif($loop eq 'H3')
    {
        $start = 'H95';
        $stop  = 'H102';
    }

    return($start, $stop);
}
